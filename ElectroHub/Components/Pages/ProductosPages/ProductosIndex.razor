@page "/Productos/Index"
@rendermode InteractiveServer
@inject CategoriasService categoriasService
@inject ProveedoresService proveedoresService
@inject ProductosService productosService

<PageTitle>Productos</PageTitle>

<div class="product-container" @onclick="()=> showAddModal = false">
    <nav>
        <span>Productos</span>
        <div class="modal-add-mobile" @onclick:stopPropagation="true">
            <svg @onclick="alternateModal" xmlns="http://www.w3.org/2000/svg" height="48px" viewBox="0 -960 960 960" width="48px" fill="#FFFFFF"><path d="M450-120v-330H120v-60h330v-330h60v330h330v60H510v330h-60Z" /></svg>
            <div class="modal-add-options @(showAddModal ? "show" : "")" @onclick:stopPropagation="true">
                <ul>
                    <li @onclick="() => { showRegisterModal = true; showAddModal = false; }">Registra Productos</li>
                    <li>Administrar Categorías</li>
                </ul>
            </div>
        </div>
    </nav>
    <hr />

    @*Filtros*@
    <section class="filter-container">
        <section class="input-container">
            <div class="form-field">
                <input type="text" placeholder="Buscar Producto..." @oninput="Buscar"/>
            </div>

            <div class="select-container">
                <select class="form-field-select" @bind="Filtro">
                    <option value="">Seleccione Filtrar Por</option>
                    <option value="CodigoProducto">Código Producto</option>
                    <option value="Nombre">Nombre</option>
                    <option value="Categoria">Categoría</option>
                    <option value="Proveedor">Proveedor</option>
                    <option value="Estado">Estado</option>
                </select>
            </div>

            <!-- CONTENEDOR NUEVO -->
            <div class="date-group">
                <div class="form-field">
                    <input type="date" @bind="FechaInicial" @bind:after="AplicarFiltros"/>
                </div>
                <div class="form-field">
                    <input type="date" @bind="FechaFinal" @bind:after="AplicarFiltros" />
                </div>
            </div>
        </section>

        @*Botón Agregar*@
        <div class="modal-add" @onclick:stopPropagation="true">
            <svg @onclick="alternateModal" xmlns="http://www.w3.org/2000/svg" height="48px" viewBox="0 -960 960 960" width="48px" fill="#AA56D7"><path d="M450-120v-330H120v-60h330v-330h60v330h330v60H510v330h-60Z" /></svg>
            <div class="modal-add-options @(showAddModal ? "show" : "")">
                <ul>
                    <li @onclick="() => {showRegisterModal = true; showAddModal = false;}">Registra Productos</li>
                    <li>Administrar Categorías</li>
                </ul>
            </div>
        </div>
    </section>

    @*Tabla*@
    <div class="table-responsive table-containaer">
        <table class="gradient-border-transparent">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Stock Mímino</th>
                    <th>Proveedor</th>
                    <th>Categoría</th>
                    <th>Opción</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var p in ProductosPaginados)
                {
                    <tr>
                        <td>@p.Nombre</td>
                        <td>@p.StockMinimo</td>
                        <td>@p.Proveedores?.NombreEmpresa</td>
                        <td>@p.Categorias?.Nombre</td>
                        <td>
                            <button @onclick="() => GetProducto(p)">Ver Detalles</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
        <div class="pagination">
            <img src="/ProductosSVG/NavigationFlechas.svg" alt="Prev" @onclick="PaginaAnterior" disabled="@(paginaActual == 1)" class="@(paginaActual == 1 ? "opacity-25" : "opacity-100")" />
            <span>@paginaActual | @TotalPaginas</span>
            <img src="/ProductosSVG/RigthNav.svg" alt="Next" @onclick="PaginaSiguiente" disabled="@(paginaActual == TotalPaginas)" class="@(paginaActual == TotalPaginas ? "opacity-25" : "opacity-100")" />
        </div>
    </div>

    @*Registro para Crear Producto*@
    <RegistroComponente @bind-Mostrar="showRegisterModal" Titulo="Registro Productos" OnCerrar="LimpiarCampos">
        <EditForm Model="Productos" OnValidSubmit="Guardar">
            <DataAnnotationsValidator />
            <section class="edit-form-container">
                <div class="scroll-inputs">
                    @* CODIGO *@
                    <div class="input-container-item">
                        <label>Código:</label>
                        <input type="number" @bind="Productos.CodigoProducto" class="form-control" />
                    </div>
                    <ValidationMessage For="() => Productos.CodigoProducto" />

                    @* NOMBRE *@
                    <div class="input-container-item">
                        <label>Nombre:</label>
                        <input type="text" @bind="Productos.Nombre" class="form-control" />
                    </div>
                    <ValidationMessage For="() => Productos.Nombre" />

                    @* DESCRIPCION *@
                    <div class="input-container-item">
                        <label>Descripción:</label>
                        <input type="text" @bind="Productos.Descripcion" class="form-control" />
                    </div>
                    <ValidationMessage For="() => Productos.Descripcion" />

                    @* CATEGORIA (Corregido: Sin ValueExpression) *@
                    <div class="input-container-item">
                        <label>Categoría:</label>
                        <select @bind="Productos.CategoriaId" class="form-control">
                            <option value="0">Seleccione una Categoría</option>
                            @foreach (var c in ListaCategorias)
                            {
                                <option value="@c.CategoriaId">@c.Nombre</option>
                            }
                        </select>
                    </div>
                    <ValidationMessage For="() => Productos.CategoriaId" />

                    @* PRECIO COMPRA *@
                    <div class="input-container-item">
                        <label>Precio Compra:</label>
                        <input type="number" @bind="Productos.PrecioCompra" class="form-control" />
                    </div>
                    <ValidationMessage For="() => Productos.PrecioCompra" />

                    @* PRECIO VENTA *@
                    <div class="input-container-item">
                        <label>Precio Venta:</label>
                        <input type="number" @bind="Productos.PrecioVenta" class="form-control" />
                    </div>
                    <ValidationMessage For="() => Productos.PrecioVenta" />

                    @* CANTIDAD *@
                    <div class="input-container-item">
                        <label>Cantidad:</label>
                        <input type="number" @bind="Productos.CantidadInventario" class="form-control" />
                    </div>
                    <ValidationMessage For="() => Productos.CantidadInventario" />

                    @* STOCK MINIMO *@
                    <div class="input-container-item">
                        <label>Stock Mínimo:</label>
                        <input type="number" @bind="Productos.StockMinimo" class="form-control" />
                    </div>
                    <ValidationMessage For="() => Productos.StockMinimo" />

                    <div class="input-container-item">
                        <label>Proveedor:</label>
                        <select @bind="Productos.ProveedorId" class="form-control">
                            <option value="0">Seleccione un Proveedor</option>
                            @foreach (var p in ListaProveedore)
                            {
                                <option value="@p.ProveedorId">@p.NombreEmpresa</option>
                            }
                        </select>
                    </div>
                    <ValidationMessage For="() => Productos.ProveedorId" />

                    @* ESTADO (Corregido: Sin ValueExpression) *@
                    <div class="input-container-item">
                        <label>Estado:</label>
                        <select @bind="Productos.EstadosProductos" class="form-control">
                            <option value="0">Seleccione un Estado</option>
                            @foreach (var e in Enum.GetValues<Estados>())
                            {
                                <option value="@e">@e</option>
                            }
                        </select>
                    </div>
                    <ValidationMessage For="() => Productos.EstadosProductos" />

                    @* FECHA *@
                    <div class="input-container-item">
                        <label>Fecha:</label>
                        <input type="date" @bind="Productos.FechaRegistro" class="form-control" />
                    </div>
                    <ValidationMessage For="() => Productos.FechaRegistro" />
                </div>
                <button type="submit">Guardar</button>
            </section>
        </EditForm>
    </RegistroComponente>

    @*Detalle Producto*@
    <DetalleComponente @bind-Mostrar="showDetailsModal" Titulo="Detalle Productos">
        <EditForm Model="productoSeleccionado" OnValidSubmit="Modificar">
            <DataAnnotationsValidator />
            <section class="edit-form-container">
                <div class="scroll-inputs">
                    @* CODIGO *@
                    <div class="input-container-item">
                        <label>Código:</label>
                        <input type="number" @bind="productoSeleccionado.CodigoProducto" class="form-control" />
                    </div>
                    <ValidationMessage For="() => productoSeleccionado.CodigoProducto" />

                    @* NOMBRE *@
                    <div class="input-container-item">
                        <label>Nombre:</label>
                        <input type="text" @bind="productoSeleccionado.Nombre" class="form-control" />
                    </div>
                    <ValidationMessage For="() => productoSeleccionado.Nombre" />

                    @* DESCRIPCION *@
                    <div class="input-container-item">
                        <label>Descripción:</label>
                        <input type="text" @bind="productoSeleccionado.Descripcion" class="form-control" />
                    </div>
                    <ValidationMessage For="() => productoSeleccionado.Descripcion" />

                    @* CATEGORIA (Corregido: Sin ValueExpression) *@
                    <div class="input-container-item">
                        <label>Categoría:</label>
                        <select @bind="productoSeleccionado.CategoriaId" class="form-control">
                            <option value="0">Seleccione una Categoría</option>
                            @foreach (var c in ListaCategorias)
                            {
                                <option value="@c.CategoriaId">@c.Nombre</option>
                            }
                        </select>
                    </div>
                    <ValidationMessage For="() => productoSeleccionado.CategoriaId" />

                    @* PRECIO COMPRA *@
                    <div class="input-container-item">
                        <label>Precio Compra:</label>
                        <input type="number" @bind="productoSeleccionado.PrecioCompra" class="form-control" />
                    </div>
                    <ValidationMessage For="() => productoSeleccionado.PrecioCompra" />

                    @* PRECIO VENTA *@
                    <div class="input-container-item">
                        <label>Precio Venta:</label>
                        <input type="number" @bind="productoSeleccionado.PrecioVenta" class="form-control" />
                    </div>
                    <ValidationMessage For="() => productoSeleccionado.PrecioVenta" />

                    @* CANTIDAD *@
                    <div class="input-container-item">
                        <label>Cantidad:</label>
                        <input type="number" @bind="productoSeleccionado.CantidadInventario" class="form-control" />
                    </div>
                    <ValidationMessage For="() => productoSeleccionado.CantidadInventario" />

                    @* STOCK MINIMO *@
                    <div class="input-container-item">
                        <label>Stock Mínimo:</label>
                        <input type="number" @bind="productoSeleccionado.StockMinimo" class="form-control" />
                    </div>
                    <ValidationMessage For="() => productoSeleccionado.StockMinimo" />

                    <div class="input-container-item">
                        <label>Proveedor:</label>
                        <select @bind="productoSeleccionado.ProveedorId" class="form-control">
                            <option value="0">Seleccione un Proveedor</option>
                            @foreach (var p in ListaProveedore)
                            {
                                <option value="@p.ProveedorId">@p.NombreEmpresa</option>
                            }
                        </select>
                    </div>
                    <ValidationMessage For="() => productoSeleccionado.ProveedorId" />

                    @* ESTADO (Corregido: Sin ValueExpression) *@
                    <div class="input-container-item">
                        <label>Estado:</label>
                        <select @bind="productoSeleccionado.EstadosProductos" class="form-control">
                            <option value="0">Seleccione un Estado</option>
                            @foreach (var e in Enum.GetValues<Estados>())
                            {
                                <option value="@e">@e</option>
                            }
                        </select>
                    </div>
                    <ValidationMessage For="() => productoSeleccionado.EstadosProductos" />

                    @* FECHA *@
                    <div class="input-container-item">
                        <label>Fecha:</label>
                        <input type="date" @bind="productoSeleccionado.FechaRegistro" class="form-control" />
                    </div>
                    <ValidationMessage For="() => productoSeleccionado.FechaRegistro" />
                </div>
                <div class="button-container">
                    <button type="submit">Guardar</button>
                    <button type="button" @onclick="Eliminar">Eliminar</button>
                </div>
            </section>
        </EditForm>
    </DetalleComponente>

    <ConfirmacionAgregadoComponente @bind-Mostrar="showAddedModal" NombreProducto="@Productos.Nombre" LimpiarObjeto="LimpiarCampos" />
    <ConfirmacionModificadoComponente @bind-Mostrar="showUpdatedModal" NombreProducto="@productoSeleccionado.Nombre" />
    <AvisoEliminarComponente @bind-Mostrar="showDeleteConfirmationModal" Productos="@productoSeleccionado" OnProductoEliminado="RefrescarLista" />
</div>

@code {
        // Modal para Crear
    private bool showAddModal = false;

    // Modal para Registrar un Producto
    private bool showRegisterModal = false;

    //Modal para Mostrar Detalles del Producto
    private bool showDetailsModal = false;

    //Modal para confirmar el registro del Producto
    private bool showAddedModal = false;

    //Modal para confirmar la modificación del Producto 
    private bool showUpdatedModal = false;

    //Modal para confirmar la eliminación del Producto
    private bool showDeleteConfirmationModal = false;

    //Filtro para el rango de Fechas
    private DateTime FechaInicial { get; set; } = DateTime.Today;
    private DateTime FechaFinal { get; set; } = DateTime.Today.Date.AddDays(1);

    //Objetos y Listas
    public Productos Productos { get; set; } = new Productos { FechaRegistro = DateTime.Now };
    public Productos productoSeleccionado { get; set; } = new Productos();

    public List<Categorias> ListaCategorias = new List<Categorias>();
    public List<Proveedores> ListaProveedore = new List<Proveedores>();
    public List<Productos> ListaProductos = new List<Productos>();
    public List<Productos> ListaProductosFiltrada = new List<Productos>();

    private void alternateModal() { showAddModal = !showAddModal; }

    //Filtro
    private string Filtro { get; set; } = string.Empty;

    //Pagination Valores
    private int paginaActual = 1;
    private int registrosPorPagina = 5;

    private int TotalPaginas =>
    (int)Math.Ceiling((double)ListaProductos.Count / registrosPorPagina);

    private IEnumerable<Productos> ProductosPaginados =>
        ListaProductos
            .Skip((paginaActual - 1) * registrosPorPagina)
            .Take(registrosPorPagina);


    protected override async Task OnInitializedAsync()
    {
        ListaCategorias = await categoriasService.Listar(c => c.Eliminado == false);
        ListaProveedore = await proveedoresService.Listar(p => p.Eliminado == false);
        ListaProductos = await productosService.Listar(p => p.Eliminado == false);
    }
    private async Task LimpiarCampos(){ Productos = new Productos { FechaRegistro = DateTime.Now };}

    private async Task RefrescarLista(){ListaProductos = await productosService.Listar(p => p.Eliminado == false);}

    private async Task Guardar()
    {
        var creado = await productosService.Guardar(Productos);
        if (creado)
        {
            showRegisterModal = false;
            ListaProductos = await productosService.Listar(p => p.Eliminado == false);
            showAddedModal = true;
        }
    }

    private async Task Modificar()
    {
        productoSeleccionado.Categorias = null;
        productoSeleccionado.Proveedores = null;
        var creado = await productosService.Guardar(productoSeleccionado);
        if (creado)
        {
            showDetailsModal = false;
            showUpdatedModal = true;
            ListaProductos = await productosService.Listar(p => p.Eliminado == false);
        }
    }

    private async Task Eliminar()
    {
        showDetailsModal = false;
        showDeleteConfirmationModal = true;
    }

    private void GetProducto(Productos p)
    {
        productoSeleccionado = p;
        showDetailsModal = true;
    }

    private string textoBusqueda = "";

    public async Task Buscar(ChangeEventArgs e)
    {
        textoBusqueda = e.Value?.ToString() ?? "";
        await AplicarFiltros();
    }

    public async Task AplicarFiltros()
    {
        var basePorFecha = await productosService.Listar(p =>
            p.Eliminado == false &&
            p.FechaRegistro.Date >= FechaInicial.Date &&
            p.FechaRegistro.Date <= FechaFinal.Date);
        if (!string.IsNullOrWhiteSpace(textoBusqueda))
        {
            if (Filtro == "Nombre")
            {
                ListaProductos = basePorFecha.Where(p => p.Nombre != null && p.Nombre.Contains(textoBusqueda, StringComparison.OrdinalIgnoreCase)).ToList();
            }
            else if (Filtro == "CodigoProducto")
            {
                if (int.TryParse(textoBusqueda, out int Codigo))
                    ListaProductos = basePorFecha.Where(p => p.CodigoProducto == Codigo).ToList();
            }
            else if (Filtro == "Categoria")
            {
                ListaProductos = basePorFecha.Where(p => p.Categorias?.Nombre != null &&
                    p.Categorias.Nombre.Contains(textoBusqueda, StringComparison.OrdinalIgnoreCase)).ToList();
            }
            else if (Filtro == "Proveedor")
            {
                ListaProductos = basePorFecha.Where(p => p.Proveedores?.NombreEmpresa != null &&
                    p.Proveedores.NombreEmpresa.Contains(textoBusqueda, StringComparison.OrdinalIgnoreCase)).ToList();
            }
            else if (Filtro == "Estado") 
            {
                ListaProductos = basePorFecha.Where(p => p.EstadosProductos.ToString()
                    .Contains(textoBusqueda, StringComparison.OrdinalIgnoreCase)).ToList();
            }
        }
        else
        {
            ListaProductos = basePorFecha.ToList();
        }
    }

    private void PaginaAnterior()
    {
        if (paginaActual > 1)
            paginaActual--;
    }

    private void PaginaSiguiente()
    {
        if (paginaActual < TotalPaginas)
            paginaActual++;
    }
}