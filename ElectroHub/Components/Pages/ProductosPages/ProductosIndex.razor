@page "/Proveedores/Index"
@rendermode InteractiveServer
@inject ProveedoresService proveedoresService

<PageTitle>Proveedores</PageTitle>

<div class="container">
    <nav>
        <span>Proveedores</span>
        <div class="modal-add-mobile" @onclick:stopPropagation="true">
            <svg @onclick="alternateModal" xmlns="http://www.w3.org/2000/svg" height="48px" viewBox="0 -960 960 960" width="48px" fill="#FFFFFF">
                <path d="M450-120v-330H120v-60h330v-330h60v330h330v60H510v330h-60Z" />
            </svg>
            <div class="modal-add-options @(showModal ? "show" : "")" @onclick:stopPropagation="true">
                <ul>
                    <li @onclick="() => showModalRegister = true">Registrar Proveedor</li>
                </ul>
            </div>
        </div>
    </nav>
    <hr />

    <section class="inputs-container">
        <div class="input-container">
            <input type="text" placeholder="Buscar Proveedor..." @oninput="Buscar" />
        </div>

        <div class="select-container">
            <select class="form-select" @bind="Filtro">
                <option value="">Seleccione Filtrar Por</option>
                <option value="NombreEmpresa">Nombre Empresa</option>
                <option value="Contacto">Contacto</option>
                <option value="Telefono">Teléfono</option>
                <option value="CorreoElectronico">Correo</option>
                <option value="TipoProveedor">Tipo</option>
                <option value="EstadoProveedor">Estado</option>
            </select>
        </div>

        <div class="modal-add">
            <svg @onclick="alternateModal" xmlns="http://www.w3.org/2000/svg" height="48px" viewBox="0 -960 960 960" width="48px" fill="#FFFFFF">
                <path d="M450-120v-330H120v-60h330v-330h60v330h330v60H510v330h-60Z" />
            </svg>
            <div class="modal-add-options @(showModal ? "show" : "")">
                <ul>
                    <li @onclick="() => showModalRegister = true">Registrar Proveedor</li>
                </ul>
            </div>
        </div>
    </section>

    <div class="table-responsive">
        <table>
            <thead>
                <tr>
                    <th>Empresa</th>
                    <th>Contacto</th>
                    <th>Teléfono</th>
                    <th>Tipo</th>
                    <th>Estado</th>
                    <th>Opción</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var p in ProveedoresPaginados)
                {
                    <tr>
                        <td>@p.NombreEmpresa</td>
                        <td>@p.Contacto</td>
                        <td>@p.Telefono</td>
                        <td>@p.TipoProveedor</td>
                        <td>@p.EstadoProveedor</td>
                        <td>
                            <button @onclick="() => GetProveedor(p)">Ver Detalles</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="pagination">
        <img src="/NavigationFlechas.svg" alt="Prev" @onclick="PaginaAnterior"
             class="@(paginaActual == 1 ? "opacity-25" : "opacity-100")" />
        <img src="/RigthNav.svg" alt="Next" @onclick="PaginaSiguiente"
             class="@(paginaActual == TotalPaginas ? "opacity-25" : "opacity-100")" />
    </div>
</div>

@code {

    private bool showModal = false;
    private bool showModalRegister = false;
    private bool showModalDetails = false;

    private string Filtro { get; set; } = string.Empty;

    private int paginaActual = 1;
    private int registrosPorPagina = 6;

    private int TotalPaginas =>
        (int)Math.Ceiling((double)ListaProveedores.Count / registrosPorPagina);

    private IEnumerable<Proveedores> ProveedoresPaginados =>
        ListaProveedores
            .Skip((paginaActual - 1) * registrosPorPagina)
            .Take(registrosPorPagina);

    public Proveedores Proveedor { get; set; } = new();

    public Proveedores proveedorSeleccionado { get; set; } = new();

    public List<Proveedores> ListaProveedores = new();

    protected override async Task OnInitializedAsync()
    {
        ListaProveedores = await proveedoresService.Listar(p => p.Eliminado == false);
    }

    private async Task RefrescarLista()
    {
        ListaProveedores = await proveedoresService.Listar(p => p.Eliminado == false);
    }

    private void alternateModal()
    {
        showModal = !showModal;
    }

    private void GetProveedor(Proveedores p)
    {
        proveedorSeleccionado = p;
        showModalDetails = true;
    }

    public async Task Buscar(ChangeEventArgs e)
    {
        var valor = e.Value?.ToString();

        if (!string.IsNullOrWhiteSpace(valor))
        {
            if (Filtro == "NombreEmpresa")
                ListaProveedores = await proveedoresService.Listar(p =>
                    p.NombreEmpresa.ToLower().Contains(valor.ToLower()) && p.Eliminado == false);

            else if (Filtro == "Contacto")
                ListaProveedores = await proveedoresService.Listar(p =>
                    p.Contacto.ToLower().Contains(valor.ToLower()) && p.Eliminado == false);

            else if (Filtro == "Telefono")
                ListaProveedores = await proveedoresService.Listar(p =>
                    p.Telefono.Contains(valor) && p.Eliminado == false);

            else if (Filtro == "CorreoElectronico")
                ListaProveedores = await proveedoresService.Listar(p =>
                    p.CorreoElectronico.ToLower().Contains(valor.ToLower()) && p.Eliminado == false);

            else if (Filtro == "TipoProveedor")
                ListaProveedores = await proveedoresService.Listar(p =>
                    p.TipoProveedor.ToString().ToLower().Contains(valor.ToLower()) && p.Eliminado == false);

            else if (Filtro == "EstadoProveedor")
                ListaProveedores = await proveedoresService.Listar(p =>
                    p.EstadoProveedor.ToString().ToLower().Contains(valor.ToLower()) && p.Eliminado == false);
        }
        else
        {
            ListaProveedores = await proveedoresService.Listar(p => p.Eliminado == false);
        }

        paginaActual = 1;
    }

    private void PaginaAnterior()
    {
        if (paginaActual > 1)
            paginaActual--;
    }

    private void PaginaSiguiente()
    {
        if (paginaActual < TotalPaginas)
            paginaActual++;
    }
}
