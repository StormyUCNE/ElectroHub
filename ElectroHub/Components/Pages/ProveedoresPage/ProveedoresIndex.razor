@page "/ProveedoresReal/Index"
@rendermode InteractiveServer
@inject ProveedoresService proveedoresService
@using ElectroHub.Models.Enums

<PageTitle>Proveedores</PageTitle>

<div class="container">
    <nav>
        <span>Proveedores</span>
        <div class="modal-add-mobile" @onclick:stopPropagation="true">
            <div class="modal-add-options @(showModal ? "show" : "")"
                 @onclick:stopPropagation="true">
            </div>
        </div>
    </nav>
    <hr />

    <section class="inputs-container">
        <div class="input-container">
            <input type="text" placeholder="Buscar Proveedor..." @oninput="Buscar" />
        </div>

        <div class="select-container">
            <select class="form-select" @bind="Filtro">
                <option value="">Seleccione Filtrar Por</option>
                <option value="NombreEmpresa">Nombre Empresa</option>
                <option value="Contacto">Contacto</option>
                <option value="Telefono">Teléfono</option>
                <option value="CorreoElectronico">Correo</option>
                <option value="TipoProveedor">Tipo</option>
                <option value="EstadoProveedor">Estado</option>
            </select>
        </div>

        <div class="modal-add">
            <svg @onclick="alternateModal" xmlns="http://www.w3.org/2000/svg"
                 height="48px" viewBox="0 -960 960 960" width="48px" fill="FFFFFF">
                <path d="M450-120v-330H120v-60h330v-330h60v330h330v60H510v330h-60Z" />
            </svg>
            <div class="modal-add-options @(showModal ? "show" : "")">
                <ul>
                    <li @onclick="() => showModalRegister = true">Registrar Proveedor</li>
                </ul>
            </div>
        </div>
    </section>

    <div class="table-responsive gradient-border-transparent">
        <table>
            <thead>
                <tr>
                    <th>Empresa</th>
                    <th>Contacto</th>
                    <th>Tipo</th>
                    <th>Estado</th>
                    <th>Opción</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var p in ProveedoresPaginados)
                {
                    <tr>
                        <td>@p.NombreEmpresa</td>
                        <td>@p.Contacto</td>
                        <td>@p.TipoProveedor</td>
                        <td>@p.EstadoProveedor</td>
                        <td>
                            <button @onclick="() => GetProveedor(p)">Ver Detalles</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="pagination">
        <img src="/NavigationFlechas.svg" @onclick="PaginaAnterior"
             class="@(paginaActual == 1 ? "opacity-25" : "opacity-100")" />
        <img src="/RigthNav.svg" @onclick="PaginaSiguiente"
             class="@(paginaActual == TotalPaginas ? "opacity-25" : "opacity-100")" />
    </div>

    <!-- MODAL REGISTRO -->
    <RegistroComponente @bind-Mostrar="showModalRegister" Titulo="Registro Proveedor">
        <EditForm Model="Proveedor" OnValidSubmit="Guardar">
            <DataAnnotationsValidator />

            <section class="edit-form-container">
                <div class="scroll-inputs">

                    <div class="input-container-item">
                        <label>Nombre Empresa:</label>
                        <input type="text" @bind="Proveedor.NombreEmpresa" class="form-control" />
                    </div>
                    <ValidationMessage For="() => Proveedor.NombreEmpresa" />

                    <div class="input-container-item">
                        <label>Contacto:</label>
                        <input type="text" @bind="Proveedor.Contacto" class="form-control" />
                    </div>
                    <ValidationMessage For="() => Proveedor.Contacto" />

                    <div class="input-container-item">
                        <label>Correo:</label>
                        <input type="email" @bind="Proveedor.CorreoElectronico" class="form-control" />
                    </div>
                    <ValidationMessage For="() => Proveedor.CorreoElectronico" />

                    <div class="input-container-item">
                        <label>Dirección:</label>
                        <input type="text" @bind="Proveedor.Direccion" class="form-control" />
                    </div>
                    <ValidationMessage For="() => Proveedor.Direccion" />

                    <div class="input-container-item">
                        <label>Tipo:</label>
                        <select @bind="Proveedor.TipoProveedor" class="form-control">
                            @foreach (var tipo in Enum.GetValues<TiposProveedores>())
                            {
                                <option value="@tipo">@tipo</option>
                            }
                        </select>
                    </div>
                    <ValidationMessage For="() => Proveedor.TipoProveedor" />

                    <div class="input-container-item">
                        <label>Estado:</label>
                        <select @bind="Proveedor.EstadoProveedor" class="form-control">
                            @foreach (var estado in Enum.GetValues<Estados>())
                            {
                                <option value="@estado">@estado</option>
                            }
                        </select>
                    </div>
                    <ValidationMessage For="() => Proveedor.EstadoProveedor" />

                </div>
                <button type="submit">Guardar</button>
            </section>
        </EditForm>
    </RegistroComponente>

    <!-- MODAL DETALLE -->
    <DetalleComponente @bind-Mostrar="showModalDetails" Titulo="Detalle Proveedor">
        <EditForm Model="proveedorSeleccionado" OnValidSubmit="Modificar">
            <DataAnnotationsValidator />

            <section class="edit-form-container">
                <div class="scroll-inputs">

                    <div class="input-container-item">
                        <label>Nombre Empresa:</label>
                        <input type="text" @bind="proveedorSeleccionado.NombreEmpresa" class="form-control" />
                    </div>

                    <div class="input-container-item">
                        <label>Contacto:</label>
                        <input type="text" @bind="proveedorSeleccionado.Contacto" class="form-control" />
                    </div>

                    <div class="input-container-item">
                        <label>Correo:</label>
                        <input type="email" @bind="proveedorSeleccionado.CorreoElectronico" class="form-control" />
                    </div>

                    <div class="input-container-item">
                        <label>Dirección:</label>
                        <input type="text" @bind="proveedorSeleccionado.Direccion" class="form-control" />
                    </div>

                    <div class="input-container-item">
                        <label>Tipo:</label>
                        <select @bind="proveedorSeleccionado.TipoProveedor" class="form-control">
                            @foreach (var tipo in Enum.GetValues<TiposProveedores>())
                            {
                                <option value="@tipo">@tipo</option>
                            }
                        </select>
                    </div>

                    <div class="input-container-item">
                        <label>Estado:</label>
                        <select @bind="proveedorSeleccionado.EstadoProveedor" class="form-control">
                            @foreach (var estado in Enum.GetValues<Estados>())
                            {
                                <option value="@estado">@estado</option>
                            }
                        </select>
                    </div>

                </div>

                <div class="button-container">
                    <button type="submit">Guardar</button>
                    <button type="button" @onclick="Eliminar">Eliminar</button>
                </div>
            </section>
        </EditForm>
    </DetalleComponente>

</div>

@code {

    private bool showModal = false;
    private bool showModalRegister = false;
    private bool showModalDetails = false;

    private string Filtro { get; set; } = string.Empty;

    private int paginaActual = 1;
    private int registrosPorPagina = 6;


    private int TotalPaginas =>
        (int)Math.Ceiling((double)ListaProveedores.Count / registrosPorPagina);

    private IEnumerable<Proveedores> ProveedoresPaginados =>
        ListaProveedores
            .Skip((paginaActual - 1) * registrosPorPagina)
            .Take(registrosPorPagina);

    public Proveedores Proveedor { get; set; } = new();

    public Proveedores proveedorSeleccionado { get; set; } = new();

    public List<Proveedores> ListaProveedores = new();

    protected override async Task OnInitializedAsync()
    {
        ListaProveedores = await proveedoresService.Listar(p => p.Eliminado == false);
    }

    private async Task Guardar()
    {
        var creado = await proveedoresService.Guardar(Proveedor);
        if (creado)
        {
            showModalRegister = false;
            ListaProveedores = await proveedoresService.Listar(p => p.Eliminado == false);
            Proveedor = new Proveedores();
        }
    }

    private async Task Modificar()
    {
        var actualizado = await proveedoresService.Guardar(proveedorSeleccionado);
        if (actualizado)
        {
            showModalDetails = false;
            ListaProveedores = await proveedoresService.Listar(p => p.Eliminado == false);
        }
    }

    private void Eliminar()
    {
        showModalDetails = false;
    }

    private void GetProveedor(Proveedores p)
    {
        proveedorSeleccionado = p;
        showModalDetails = true;
    }

    private void alternateModal()
    {
        showModal = !showModal;
    }

    private void PaginaAnterior()
    {
        if (paginaActual > 1)
            paginaActual--;
    }

    private void PaginaSiguiente()
    {
        if (paginaActual < TotalPaginas)
            paginaActual++;
    }

    public async Task Buscar(ChangeEventArgs e)
    {
        var valor = e.Value?.ToString();

        if (!string.IsNullOrWhiteSpace(valor))
        {
            if (Filtro == "NombreEmpresa")
                ListaProveedores = await proveedoresService.Listar(p =>
                    p.NombreEmpresa.ToLower().Contains(valor.ToLower()) && !p.Eliminado);

            else if (Filtro == "Contacto")
                ListaProveedores = await proveedoresService.Listar(p =>
                    p.Contacto.ToLower().Contains(valor.ToLower()) && !p.Eliminado);

            else if (Filtro == "CorreoElectronico")
                ListaProveedores = await proveedoresService.Listar(p =>
                    p.CorreoElectronico.ToLower().Contains(valor.ToLower()) && !p.Eliminado);

            else if (Filtro == "TipoProveedor")
                ListaProveedores = await proveedoresService.Listar(p =>
                    p.TipoProveedor.ToString().ToLower().Contains(valor.ToLower()) && !p.Eliminado);

            else if (Filtro == "EstadoProveedor")
                ListaProveedores = await proveedoresService.Listar(p =>
                    p.EstadoProveedor.ToString().ToLower().Contains(valor.ToLower()) && !p.Eliminado);
        }
        else
        {
            ListaProveedores = await proveedoresService.Listar(p => !p.Eliminado);
        }

        paginaActual = 1;
    }
}
