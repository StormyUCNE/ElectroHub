@page "/Inventario/Index"
@rendermode InteractiveServer
@inject InventarioService inventarioService

<PageTitle>Inventario & Auditoría</PageTitle>

<div class="container">
    <nav class="d-flex justify-content-start">
        <span>GESTIÓN DE INVENTARIO & AUDITORÍA</span>
    </nav>
    <hr />

    <section class="inputs-container">
        <div class="input-container">
            <input type="text" placeholder="Buscar Producto..." @oninput="Buscar" />
        </div>
        
        <div class="input-container" onclick="this.querySelector('input').showPicker()">
            <input type="date" @bind="FiltroFecha" @bind:after="FiltrarPorFecha" />
        </div>

        <div class="select-container">
            <select @bind="FiltroTipoMovimiento" @bind:after="RefrescarLista">
                <option value="">TIPO MOVIMIENTO</option>
                <option value="Entrada">Entrada</option>
                <option value="Salida">Salida</option>
                <option value="Ajuste">Ajuste</option>
            </select>
        </div>
    </section>

    <div class="table-responsive gradient-border-transparent">
        <table>
            <thead>
                <tr>
                    <th>FECHA/HORA</th>
                    <th>PRODUCTO</th>
                    <th>CATEGORÍA</th>
                    <th>TIPO MOV.</th>
                    <th>CANTIDAD</th>
                    <th>USUARIO</th>
                    <th>STOCK FINAL</th>
                    <th>OPCIONES</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var mov in MovimientosPaginados)
                {
                    <tr>
                        <td>@mov.FechaMovimiento.ToString("dd/MM/yy HH:mm")</td>
                        <td style="text-transform: uppercase;">@mov.Producto?.Nombre</td>
                        <td style="text-transform: uppercase;">@mov.Producto?.Categorias?.Nombre</td>
                        <td>
                            <span class="badge-@(mov.TipoMovimiento.ToLower())">@mov.TipoMovimiento.ToUpper()</span>
                        </td>
                        <td style="font-weight: bold; color: @(mov.Cantidad > 0 ? "#7ED957" : "#FF3131")">
                            @(mov.Cantidad > 0 ? "+" : "")@mov.Cantidad
                        </td>
                        <td>@mov.Usuario</td>
                        <td>@mov.StockResultante</td>
                        <td>
                            <button class="btn-detalles">ⓘ DETALLES</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="pagination">
        <img src="/NavigationFlechas.svg" alt="Prev"
             @onclick="PaginaAnterior"
             class="@(paginaActual == 1 ? "opacity-25" : "opacity-100")" />
        
        <span style="color: white; font-weight: bold;">@paginaActual de @TotalPaginas</span>
        
        <img src="/RigthNav.svg" alt="Next"
             @onclick="PaginaSiguiente"
             class="@(paginaActual >= TotalPaginas ? "opacity-25" : "opacity-100")" />
    </div>
</div>

@code {
    private DateTime? FiltroFecha { get; set; }
    private string FiltroTipoMovimiento { get; set; } = string.Empty;
    private int paginaActual = 1;
    private int registrosPorPagina = 8;

    public List<InventarioMovimientos> ListaMovimientos = new();
    public List<InventarioMovimientos> ListaFiltrada = new();

    protected override async Task OnInitializedAsync()
    {
        await RefrescarLista();
    }

    private async Task RefrescarLista()
    {
        // Cargar lista base
        ListaMovimientos = await inventarioService.Listar(m => true);
        
        // Aplicar filtros adicionales de UI
        ListaFiltrada = ListaMovimientos;
        
        if (!string.IsNullOrEmpty(FiltroTipoMovimiento))
            ListaFiltrada = ListaFiltrada.Where(m => m.TipoMovimiento == FiltroTipoMovimiento).ToList();

        paginaActual = 1; // Siempre resetear al filtrar
    }

    private int TotalPaginas => (int)Math.Ceiling((double)ListaFiltrada.Count / registrosPorPagina) == 0 ? 1 : (int)Math.Ceiling((double)ListaFiltrada.Count / registrosPorPagina);

    private IEnumerable<InventarioMovimientos> MovimientosPaginados =>
        ListaFiltrada.Skip((paginaActual - 1) * registrosPorPagina).Take(registrosPorPagina);

    public async Task Buscar(ChangeEventArgs e)
    {
        var valor = e.Value?.ToString()?.ToLower();
        if (string.IsNullOrEmpty(valor))
            await RefrescarLista();
        else
        {
            ListaFiltrada = ListaMovimientos.Where(m => m.Producto!.Nombre.ToLower().Contains(valor)).ToList();
            paginaActual = 1;
        }
    }

    private async Task FiltrarPorFecha() => await RefrescarLista();

    private void PaginaAnterior() { if (paginaActual > 1) paginaActual--; }
    
    private void PaginaSiguiente()
    {
        if (paginaActual < TotalPaginas)
            paginaActual++;
    }
}