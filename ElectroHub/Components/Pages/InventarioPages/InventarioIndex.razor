@page "/Inventario/Index"
@rendermode InteractiveServer
@inject InventarioService inventarioService

<PageTitle>Inventario & Auditoría</PageTitle>

<div class="container">
    <nav class="d-flex justify-content-start">
        <span>GESTIÓN DE INVENTARIO & AUDITORÍA</span>
    </nav>
    <hr />

    <section class="inputs-container">
        <div class="input-container">
            <input type="text" placeholder="Buscar Producto..." @oninput="Buscar" />
        </div>
        
        <div class="input-container" onclick="this.querySelector('input').showPicker()">
            <input type="date" @bind="FiltroFecha" @bind:after="FiltrarPorFecha" />
        </div>

        <div class="select-container">
            <select @bind="FiltroTipoMovimiento" @bind:after="RefrescarLista">
                <option value="">TIPO MOVIMIENTO</option>
                <option value="Entrada">Entrada</option>
                <option value="Salida">Salida</option>
                <option value="Ajuste">Ajuste</option>
            </select>
        </div>
    </section>

    <div class="table-responsive gradient-border-transparent">
        <table>
            <thead>
                <tr>
                    <th>FECHA/HORA</th>
                    <th>PRODUCTO</th>
                    <th>CATEGORÍA</th>
                    <th>TIPO MOV.</th>
                    <th>CANTIDAD</th>
                    <th>USUARIO</th>
                    <th>STOCK FINAL</th>
                    <th>OPCIONES</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var mov in MovimientosPaginados)
                {
                    <tr>
                        <td>@mov.FechaMovimiento.ToString("dd/MM/yy HH:mm")</td>
                        <td style="text-transform: uppercase;">@mov.Producto?.Nombre</td>
                        <td style="text-transform: uppercase;">@mov.Producto?.Categorias?.Nombre</td>
                        <td>
                            <span class="badge-@(mov.TipoMovimiento.ToLower())">@mov.TipoMovimiento.ToUpper()</span>
                        </td>
                        <td style="font-weight: bold; color: @(mov.Cantidad > 0 ? "#7ED957" : "#FF3131")">
                            @(mov.Cantidad > 0 ? "+" : "")@mov.Cantidad
                        </td>
                        <td>@mov.Usuario</td>
                        <td>@mov.StockResultante</td>
                        <td>
                            <button class="btn-detalles" @onclick="() => VerDetalles(mov)">ⓘ DETALLES</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="pagination">
        <img src="/NavigationFlechas.svg" alt="Prev" @onclick="PaginaAnterior" class="@(paginaActual == 1 ? "opacity-25" : "opacity-100")" style="cursor: pointer;" />
        <span style="color: white; font-weight: bold;">@paginaActual de @TotalPaginas</span>
        <img src="/RigthNav.svg" alt="Next" @onclick="PaginaSiguiente" class="@(paginaActual >= TotalPaginas ? "opacity-25" : "opacity-100")" style="cursor: pointer;" />
    </div>

    @* --- MODAL DE DETALLES --- *@
    @* --- MODAL DE DETALLES CORREGIDO --- *@
    <DetalleComponente @bind-Mostrar="showModalDetails" Titulo="@($"DETALLES: {movimientoSeleccionado?.Producto?.Nombre}")">
        <section class="edit-form-container">
            <div class="d-flex justify-content-end mb-2">
                <span class="badge-@(movimientoSeleccionado?.TipoMovimiento?.ToLower())" style="font-size: 1rem; padding: 5px 15px;">
                    @movimientoSeleccionado?.TipoMovimiento?.ToUpper()
                </span>
            </div>

            @* Ajuste de columnas para evitar saltos de línea *@
            <div class="d-flex justify-content-around mb-4" style="color: white; font-weight: bold; font-size: 0.85rem; white-space: nowrap;">
                <div class="d-flex align-items-center">
                    <div style="border: 2px solid #00F2FF; border-radius: 50%; width: 12px; height: 12px; display: inline-block;"></div>
                    <span class="ms-2">Anterior: @(movimientoSeleccionado?.StockResultante - movimientoSeleccionado?.Cantidad)</span>
                </div>
                <div class="d-flex align-items-center">
                    <div style="border: 2px solid #00F2FF; border-radius: 50%; width: 12px; height: 12px; display: inline-block;"></div>
                    <span class="ms-2">Cant: @movimientoSeleccionado?.Cantidad</span>
                </div>
                <div class="d-flex align-items-center">
                    <div style="border: 2px solid #00F2FF; border-radius: 50%; width: 12px; height: 12px; display: inline-block;"></div>
                    <span class="ms-2">Final: @movimientoSeleccionado?.StockResultante</span>
                </div>
            </div>

            <div class="row">
                <div class="col-md-5 border-end border-secondary">
                    <h6 class="text-white fw-bold mb-3" style="font-size: 0.85rem; letter-spacing: 1px;">INFORMACIÓN PRODUCTO</h6>
                    <div class="text-white-50 small">
                        <p class="mb-1"><strong class="text-white">PRODUCTO:</strong> @movimientoSeleccionado?.Producto?.Nombre</p>
                    
                        @* Cambiado a la propiedad de código del producto *@
                        <p class="mb-1"><strong class="text-white">SKU:</strong> @movimientoSeleccionado?.Producto?.CodigoProducto</p>
                    
                        <p class="mb-1"><strong class="text-white">CATEGORÍA:</strong> @movimientoSeleccionado?.Producto?.Categorias?.Nombre?.ToUpper()</p>
                        
                        @* --- CORRECCIÓN PROVEEDOR LARGO --- *@
                        <p class="mb-1" style="word-break: break-all; line-height: 1.2;">
                            <strong class="text-white">PROVEEDOR:</strong>
                            @movimientoSeleccionado?.Producto?.Proveedores?.NombreEmpresa?.ToUpper()
                        </p>
                    </div>
                </div>

                <div class="col-md-7 ps-4">
                    <h6 class="text-white fw-bold mb-3" style="font-size: 0.85rem; letter-spacing: 1px;">DETALLES DEL MOVIMIENTO</h6>
                    <div class="text-white-50 small">
                        <p class="mb-2"><strong class="text-white">OPERADOR:</strong> @movimientoSeleccionado?.Usuario?.ToUpper()</p>
                        <p class="mb-2"><strong class="text-white">Nro. de Referencia:</strong> REF: #FAC-@movimientoSeleccionado?.MovimientoId</p>
                        <p class="mb-2"><strong class="text-white">FECHA:</strong> @movimientoSeleccionado?.FechaMovimiento.ToString("dd/MM/yy HH:mm")</p>
                        <p class="mb-2"><strong class="text-white">UBICACIÓN:</strong> ALMACÉN CENTRAL</p>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-center mt-4">
                <button class="btn" @onclick="() => showModalDetails = false"
                        style="background: #5D5FEF; color: white; border-radius: 20px; padding: 5px 50px; font-weight: bold; font-size: 0.9rem;">
                    CERRAR
                </button>
            </div>
        </section>
    </DetalleComponente>
</div>

@code {
    private DateTime? FiltroFecha { get; set; }
    private string FiltroTipoMovimiento { get; set; } = string.Empty;
    private int paginaActual = 1;
    private int registrosPorPagina = 8;
    private bool showModalDetails = false;
    private InventarioMovimientos? movimientoSeleccionado;

    public List<InventarioMovimientos> ListaMovimientos = new();
    public List<InventarioMovimientos> ListaFiltrada = new();

    protected override async Task OnInitializedAsync() => await RefrescarLista();

    private void VerDetalles(InventarioMovimientos mov)
    {
        movimientoSeleccionado = mov;
        showModalDetails = true;
    }

    private async Task RefrescarLista()
    {
        ListaMovimientos = await inventarioService.Listar(m => true);
        ListaFiltrada = ListaMovimientos;
        if (!string.IsNullOrEmpty(FiltroTipoMovimiento))
            ListaFiltrada = ListaFiltrada.Where(m => m.TipoMovimiento == FiltroTipoMovimiento).ToList();
        paginaActual = 1;
    }

    private int TotalPaginas => (int)Math.Ceiling((double)ListaFiltrada.Count / registrosPorPagina) == 0 ? 1 : (int)Math.Ceiling((double)ListaFiltrada.Count / registrosPorPagina);

    private IEnumerable<InventarioMovimientos> MovimientosPaginados =>
        ListaFiltrada.Skip((paginaActual - 1) * registrosPorPagina).Take(registrosPorPagina);

    public async Task Buscar(ChangeEventArgs e)
    {
        var valor = e.Value?.ToString()?.ToLower();
        if (string.IsNullOrEmpty(valor)) await RefrescarLista();
        else
        {
            ListaFiltrada = ListaMovimientos.Where(m => m.Producto!.Nombre.ToLower().Contains(valor)).ToList();
            paginaActual = 1;
        }
    }

    private async Task FiltrarPorFecha() => await RefrescarLista();
    private void PaginaAnterior() { if (paginaActual > 1) paginaActual--; }
    private void PaginaSiguiente() { if (paginaActual < TotalPaginas) paginaActual++; }
}